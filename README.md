# Raspberry БК-0011M (К1801ВМ1 - PDP-11 based) Emulator for MURMULATOR devboard
Based on: https://github.com/konst-st/BK8266/tree/BK0011M, который базируется на основе эмулятора для ESP8266 https://github.com/konst-st/BK8266

Эмулятор БК-0010(-01)/БК-0011М на Raspberry Pi Pico 2 (RP2350)<br/>
![BK-0010 https://t.me/bk0010_11m/414865/503224](/bk0010-flat-keyboard.jpg)<br/>


# Hardware required
Данные исходники тестировались только с Murmulator devboard с VGA и HDMI выходом.<br/>
Схема простейшего мурмулятора доступна тут: https://github.com/AlexEkb4ever/MURMULATOR_classical_scheme<br/>
![Murmulator Schematics](https://github.com/javavi/pico-infonesPlus/blob/main/assets/Murmulator-1_BSchem.JPG)<br/>
[S]VGA monitor с поддержкой режима 1024х768 60Гц или HDMI с 800х600 60Гц<br>
Для VGA вывод осуществляется с удвоением точек 512x2->1024 и с утроением линий 256x3->768 в Ч.Б режиме и
с учетверением точек 256x4->1024 и с утроением линий 256x3->768 в цветном.<br>
Для HDMI - используются поля для масштабирования, т.е. изображение меньше, чем размер экрана.
Из-за несовпадения пропорций пикселей HDMI и БК, рекомендуется включит монитор в режим 16:9,
так какртинка выглядит естественней. VGA такой проблемы не имеет, и рекомендуется использовать режим монитора 4:3.<br>

# Эмулятор К1801ВМ1
Эмулятор цельнотянутый с https://github.com/konst-st/BK8266/tree/BK0011M.<br/>
Кое чего подсмотрено из эмулятора Юрия Калмыкова http://gid.pdp-11.ru<br/>
Эмулятор процессора работает в режиме К1801ВМ1 (без "Г")<br/>

Эмулятор пока использует только ОЗУ RP2350 (из которых 128 кБ выделено под ОЗУ БК0011М).<br/>
ПЗУ БК 0010 монитор / БК 0011М БОС, Бейсик и фокал содержится во флэш (используется встроеннное кэширование пики).<br/>
Поддерживается эмулятор звукового сопроцессора AY-3-8910 в варианте БК TurboSound на одном чипе (моно).<br/>
Эмулятор Covox гибридный - основная часть (моно) на старндартном регистре параллельного порта с loopback. Также реализован стерео вариант на наборе регистров от AZБК, но без ПДП.<br/>

Пока не реализовано:
<ul>
<li>Прерывание по вектору 14 после выполнения каждой команды при установленном в PSW бите T (трассировка).</li>
</ul>

# Периферия
<ul>
<li>PS/2 клавиатура с автоматической перекодировкой русских букв и спец.символов</li>
<li>Dendy джойстик</li>
<li>Wii джойстик</li>
<li>Маппинг двух джойстиков на произвольные кнопки PS/2 клавиатуры</li>
<li>Звук от пищалки и моно-Covox на порту 177714 выводится в виде 12-ти битного ШИМ.</li>
<li>Таймер БК-0010 (регистры 177706, 177710, 177712).</li>
<li>Прерывание (0100) от таймера БК-0011М (50 Гц).</li>
</ul>

# Раскладка клавиатуры
Соответствие клавишам БК-0011М:
<ul>
<li>любой Alt - АР2</li>
<li>любой Shift - Нижний регистр</li>
<li>любой Ctrl - СУ</li>
<li>Caps Lock - Переключение ЗАГЛ / СТР</li>
<li>левый Win - РУС*</li>
<li>правый Win - ЛАТ</li>
<li>Pause - СТОП</li>
<li>F1 - ПОВТ</li>
<li>F2 - КТ</li>
<li>F3 - =|=>|</li>
<li>F4 - |<==</li>
<li>F5 - |==></li>
<li>F6 - ИНД СУ</li>
<li>F7 - БЛОК РЕД</li>
<li>F8 - ШАГ</li>
<li>F9 - СБР</li>
<li>Page Up / Page Down - ВС</li>
<li>* - Если установлен флаг конфигурации is_swap_wins_enabled (по умолчанию), то левый и правый Win взаимозаменяемые и переключают язык циклически. Если нет, работает старая схема - левый - РУС, правый - ЛАТ.</li>
</ul>

Клавиши эмуляции джойстика по-умолчанию:
<ul>
<li>A - разряд 0 параллельного порта (регистр 0177714) - аналог DPAD_A</li>
<li>Q - разряд 1 порта - DPAD_B</li>
<li>S - разряд 2 порта - DPAD_SELECT</li>
<li>D - разряд 3 порта - DPAD_START</li>
<li>P - разряд 4 порта - DPAD_UP</li>
<li>; - разряд 5 порта - DPAD_DOWN</li>
<li>L - разряд 6 порта - DPAD_LEFT</li>
<li>, - разряд 7 порта - DPAD_RIGHT</li>
<li>W - разряд 8 порта - DPAD_A (второго джойстика)</li>
<li>Z - разряд 9 порта - DPAD_B</li>
<li>X - разряд 10 порта - DPAD_SELECT</li>
<li>O - разряд 11 порта - DPAD_START</li>
<li>K - разряд 12 порта - DPAD_UP</li>
<li>. - разряд 13 порта - DPAD_DOWN</li>
<li>E - разряд 14 порта - DPAD_LEFT</li>
<li>I - разряд 15 порта - DPAD_RIGHT</li>

</ul>

Биты денди-джойстика №1 (или эмуояции):
<ul>
<li>DPAD_A - Кнопка А (разряд 0 порта)</li>
<li>DPAD_B - Кнопка В (разряд 1 порта)</li>
<li>SELECT - Кнопка Select (разряд 2 порта)</li>
<li>START  - Кнопка START (разряд 3 порта)</li>
<li>DPAD_UP - Вверх (разряд 4 порта)</li>
<li>DPAD_DOWN - Вниз (разряд 5 порта)</li>
<li>DPAD_LEFT - Влево (разряд 6 порта)</li>
<li>DPAD_RIGHT - Вправо (разряд 7 порта)</li>
</ul>

Биты эмуояции джойстика №2:
<ul>
<li>DPAD_A - Кнопка А (разряд 8 порта)</li>
<li>DPAD_B - Кнопка В (разряд 9 порта)</li>
<li>SELECT - Кнопка Select (разряд 10 порта)</li>
<li>START  - Кнопка START (разряд 11 порта)</li>
<li>DPAD_UP - Вверх (разряд 12 порта)</li>
<li>DPAD_DOWN - Вниз (разряд 13 порта)</li>
<li>DPAD_LEFT - Влево (разряд 14 порта)</li>
<li>DPAD_RIGHT - Вправо (разряд 15 порта)</li>
</ul>

Клавиши эмулятора:
<ul>
<li>Ctrl + Alt + Del - Reset ВМ1 CPU, RAM cleanup, set default pages, deafult speed, init system registers</li>
<li>Shift + Ctrl + Alt + Del - Reset ВМ1 CPU, 32K RAM cleanup, init system registers (неполная инициализация при перезагрузке - пропускает инициализацию страниц памяти, части регистов, и заменяет адрес загрузки с 140000 на 100000 (для БК-0011М))</li>
<li>Print Screen - Reset RP2040/RP2350 CPU</li>
<li>Home - выход в файловый менеджер эмулятора</li>
<li>F10 - Циклическое переключение палитры для подбора удобной для игры (если это поленился сделать разработчик оной)</li>
<li>Alt  + F10 - Установить нулевую палитру (нативную палитру БК-0010[-01])</li>
<li>Ctrl + F10 - Установить 15-ую палитру (нативную палитру БК-0011М)</li>
<li>F11 - Снижение яркости (сочности) цветов</li>
<li>F12 - Быстрое переключение между чёрно-белым режимом на 512 точек в строке в цветной на 256 точек и обратно</li>
<li>Ctrl + F1..F8 - быстрое сохранение снепшота (в файл BK\SNAP[1..8].BKE)</li>
<li>Alt  + F1..F8 - быстрое восстановление из снепшота</li>
<li>Ctrl + F11 замедление эмуляции*</li>
<li>Ctrl + F12 ускорение эмуляции.</li>
<li>Scroll Lock - включить режим Turbo</li>
<li> * скорость эмуляции по умолчанию примерно соответствует частоте процессора в 3 МГц для БК0010[-01] и 4 МГц для БК0011М </li>
<li>Ctrl + "+" - увеличить громкость</li>
<li>Ctrl + "-" - уменьшить громкость</li>
<li>Ctrl + Alt + "+" - увеличить громкость обратной шипелки (при загрузке с магнитофона)</li>
<li>Ctrl + Alt + "-" - уменьшить громкость обратной шипелки (при загрузке с магнитофона)</li>
<li>Ctrl + Tab + "+" - увеличить собственную частоту микроконтроллера RP2040</li>
<li>Ctrl + Tab + "-" - уменьшить собственную частоту микроконтроллера RP2040</li>
<li>Ctrl + Tab + "A" - AY-3-8910 вкл / выкл</li>
<li>Ctrl + Tab + "C" - Covox вкл / выкл</li>
<li>Ctrl + Tab + Backspace - перемонтировать fdd0.img и fdd1.img, поменяв их местами</li>
<li>Num Lock - вкллючение эмуляции джойстика (is_kbd_joystick)</li>
</ul>

Клавиши менеджера:
<ul>
<li>Up / PageUp - Вверх</li>
<li>Down / PageDown - Вниз</li>
<li>Enter - запустить BIN файл, зайти в папку или смонтировать IMG/BKD файл, и выйти из манагера с ресетом (если не выбрано "BK-0010 + КНГМД 16k", то автоматически выбирается "BK-0011М + КНГМД", для режима "BK-0010 + КНГМД 16k" работает клавиатурный скрипт, который автоматическик набирает "S160000 Enter" для запуска КНГМД), запуск BKE-снэпшотов.</li>
<li>Ctrl + Enter - просмотр содержимого images формата МКДОС.</li>
<li>F1 - Краткая справка</li>
<li>F2 - Настроить текущую конфигурацию и сохранить её в файл BK\bk.conf (если при выходе нажать Enter)</li>
<li>F3 - Быстрый выбор БК0010 + КНГМД 16К</li>  
<li>F4 - Быстрый выбор БК0011М + КНГМД</li>  
<li>F5 - Копировать файл / папку</li>
<li>F6 - Переместить файл / папку</li>
<li>F7 - Создать папку</li>
<li>F8 - Удалить файл / папку</li>
<li>F10 - Выход из менеджера (блокируется до окончания сеанса USB-host)</li>
<li>F11 - Меню переключения режима эмуляции: БК-0010-01 (Вильнюс Бейсик 86), БК-0011М (Бейсик Экситон) + КНГМД, БК-0011М + МСТД, БК-0010 + КНГМД А10, БК-0010 Фокал (с глюками)</li>
<li>F12 - Предустановить режим цвета эмулятора</li>
<li>Ctrl + F2 - Сохранить состояние БК в файл BK\SNAP2.BKE</li>
<li>Alt + F2 - Восстановить состояние БК из файла BK\SNAP2.BKE и выйти в режим эмуляции</li>
<li>Alt + F10 - Монтировать SD-card мурмулятора, как USB-drive</li>
<li>Ctrl + F10 - Выход в Мурмулятор-ОС</li>
</ul>

Конфигурационный файл (BK\bk.conf):
<ul>
<li>mode: - значения от 0 до 4 - режимы страта:
<ul>
<li>0 - БК-0010 + КНГМД А16</li>
<li>1 - БК-0010 + Фокал</li>
<li>2 - БК-0010-01 + Вильнюс Бейсик 86</li>
<li>3 - БК-0011М + Бейсик Экситон + КНГМД</li>
<li>4 - БК-0011М + МСТД</li>
</ul>
</li>
<li>is_covox_on: - 0/1</li>
<li>is_AY_on: - 0/1</li>
<li>color_mode: - 0/1</li>
<li>snd_volume: - -16..5</li>
<li>graphics_pallette_idx: - 0..15</li>
<li>is_swap_wins_enabled: 0/1 (по умолчанию: 1, т.е. левый и правый Win взаимозаменяемые и переключают язык циклически.</li>
<li>is_dendy_joystick: - 0/1 включает поддержку Dendy/Wii-джойстиков (если is_dendy_joystick включен, то covox-loppback (не сам covox) выключается, т.к. они конфликтуют (используют один порт))</li>
<li>is_kbd_joystick: 0/1 (если is_kbd_joystick включен, то covox-loppback выключается) с дендиджоем несовместимо, если включен денди, то он перебивает эмуляцию</li>
</ul>
При возникновении проблем, первое, что следует попробовать - удалить файл конфигурации вручную.</br>

Управление эмулятором с помощью Dendy (или Wii)-джойстика (первого):
<ul>
<li>START + SELECT - выход в режим менеджера</li>
<li>UP / DOWN - навигация по файловой панели</li>
<li>LEFT / RIGHT - смена панели (смена значения в меню конфигурации)</li>
<li>START - аналог Enter</li>
<li>A - аналог ОК в менюшках</li>
<li>B - в менюшках аналог Esc</li>
<li>SELECT + A - вход в конфиг</li>
<li>SELECT + B - выход в эмуляцию</li>
<li>START + A - mount USB</li>
<li>START + B - reset</li>
</ul>
