# Raspberry БК-0011M (К1801ВМ1 - PDP-11 based) Emulator for MURMULATOR devboard
Based on:

# БК-0011М https://github.com/konst-st/BK8266/tree/BK0011M
Эмулятор БК-0011М на Raspberry Pi Pico (RP2040)<br/>
Сделан на основе эмулятора для ESP8266 https://github.com/konst-st/BK8266

# Hardware needed
To get it working you should have an Murmulator (development) board with VGA output. Schematics available here at https://github.com/AlexEkb4ever/MURMULATOR_classical_scheme
![Murmulator Schematics](https://github.com/javavi/pico-infonesPlus/blob/main/assets/Murmulator-1_BSchem.JPG)

Extra PSRAM support (для ещё незаконченной СМК-512) on pi pico pins:
* PSRAM_PIN_CS=18
* PSRAM_PIN_SCK=19
* PSRAM_PIN_MOSI=20
* PSRAM_PIN_MISO=21
![RAM extention](/psram.jpg)

# Эмулятор К1801ВМ1
Эмулятор цельнотянутый с https://github.com/konst-st/BK8266/tree/BK0011M.<br/>
Кое чего подсмотрено из эмулятора Юрия Калмыкова http://gid.pdp-11.ru<br/>

Эмулятор пока использует только ОЗУ RP2040 (из которых 128 кБ выделено под ОЗУ БК0011М).<br/>
ПЗУ БК11М содержится во флэш (используется встроеннное кэширование пики).<br/>
Эмулятор звукового сопроцессора AY-3-8910 в варианте TurboSound на одном чипе.<br/>
Эмулятор Covox гибридный - основная часть (моно) на старндартном регистре параллельного порта с loopback. Также реализован стерео вариант на наборе регистров от AZБК, но без ПДП.<br/>

Пока не реализовано:
<ul>
<li>Прерывание по вектору 14 после выполнения каждой команды при установленном в PSW бите T (трассировка).</li>
<li>Прерывание от таймера БК-0011М (50 Гц).</li>
</ul>

# Периферия
<ul>
<li>PS/2 клавиатура с автоматической перекодировкой русских букв и спец.символов</li>
<li>Звук от пищалки и моно-Covox на порту 177714 выводится в виде 12-ти битного ШИМ.</li>
<li>Реализована эмуляция таймера БК-0010 (регистры 177706, 177710, 177712).</li>
</ul>

# Раскладка клавиатуры
Соответствие клавишам БК-0011М:
<ul>
<li>любой Alt - АР2</li>
<li>любой Shift - Нижний регистр</li>
<li>любой Ctrl - СУ</li>
<li>Caps Lock - Переключение ЗАГЛ / СТР</li>
<li>левый Win - РУС</li>
<li>правый Win - ЛАТ</li>
<li>Pause - СТОП</li>
<li>F1 - ПОВТ</li>
<li>F2 - КТ</li>
<li>F3 - =|=>|</li>
<li>F4 - |<==</li>
<li>F5 - |==></li>
<li>F6 - ИНД СУ</li>
<li>F7 - БЛОК РЕД</li>
<li>F8 - ШАГ</li>
<li>F9 - СБР</li>
</ul>

Клавиши джойстика (не тестировалось - пока нет джойстика):
<ul>
<li>Up - Вверх (разряд 0 порта)</li>
<li>Right - Вправо (разряд 2 порта)</li>
<li>Down - Вниз (разряд 3 порта)</li>
<li>Left - Влево (разряд 4 порта)</li>
<li>Пробел - Кнопка 1 (разряд 1 порта)</li>
<li>A - Кнопка 2 (разряд 5 порта)</li>
<li>S - Кнопка 3 (разряд 6 порта)</li>
<li>D - Кнопка 4 (разряд 7 порта)</li>
<li>F - Кнопка 5 (разряд 8 порта)</li>
</ul>

Клавиши эмулятора:
<ul>
<li>Ctrl + Alt + Del - Reset ВМ1 CPU, RAM clenup, set default pages, deafult speed, init system registers</li>
<li>Print Screen - Reset RP2040 CPU</li>
<li>Esc - выход в файловый менеджер эмулятора (частично функционально)</li>
<li>F10 - Циклическое переключение палитры для подбора удобной для игры (если это поленился сделать разработчик)</li>
<li>Alt  + F10 - Установить нулевую палитру (нативную палитру БК-0010[-01])</li>
<li>Ctrl + F10 - Установить 15-ую палитру (нативную палитру БК-0011М)</li>
<li>F11 - Снижение яркости (сочности) цветов</li>
<li>F12 - Быстрое переключение между чёрно-белым режимом на 512 точек в строке в цветной на 256 точек и обратно</li>
<li>Alt  + F1..F8 - быстрое сохранение снепшота (в файл BK\SNAP[1..8].BKE)</li>
<li>Ctrl + F1..F8 - быстрое восстановление из снепшота</li>
<li>Ctrl + F11 замедление эмуляции*</li>
<li>Ctrl + F12 ускорение эмуляции.</li>
<li> * по умолчанию скорость эмуляции примерно соответствует частоте процессора в 3 МГц (константа замедления: 6)</li>
<li>Ctrl + "+" - увеличить громкость</li>
<li>Ctrl + "-" - уменьшить громкость</li>
<li>Ctrl + Alt + "+" - увеличить громкость обратной шипелки (при загрузке с магнитофона)</li>
<li>Ctrl + Alt + "-" - уменьшить громкость обратной шипелки (при загрузке с магнитофона)</li>
<li>Ctrl + Tab + "+" - увеличить частоту микроконтроллера</li>
<li>Ctrl + Tab + "-" - уменьшить частоту микроконтроллера</li>
<li>Ctrl + Tab + "A" - AY-3-8910 вкл / выкл</li>
<li>Ctrl + Tab + "C" - Covox вкл / выкл</li>
<li>Ctrl + Tab + Backspace - перемонтировать fdd0.img и fdd1.img (поменяв их местами)</li>
<li>Num Lock - переключение клавиш в режим джойстика (не тестировалось)</li>
</ul>

Клавиши менеджера:
<ul>
<li>Ctrl + Alt + Del - Reset ВМ1 CPU, RAM clenup, set default pages, deafult speed, init system registers</li>
<li>Up / PageUp - Вверх</li>
<li>Down / PageDown - Вниз</li>
<li>Enter - запустить BIN файл, зайти в папку или смонтировать IMG/BKD файл, и выйти из манагера с ресетом (если не выбрано "BK-0010 + КНГМД 16k", то автоматически выбирается "BK-0011М + КНГМД"), запуск BKE-snapshots.</li>
<li>Ctrl + Enter - просмотр содержимого images формата МКДОС.</li>
<li>F1 - Краткая справка</li>
<li>F2 - Сохранить состояние БК в файл BK\SNAP2.BKE</li>
<li>Ctrl + F2 - Восстановить состояние БК из файла BK\SNAP2.BKE и выйти в режим эмуляции</li>
<li>F5 - Копировать файл / папку</li>
<li>F6 - Переместить файл / папку</li>
<li>F8 - Удалить файл / папку</li>
<li>F10 - Выход из менеджера (блокируется до окончания сеанса USB-host)</li>
<li>F11 - Меню переключения режима эмуляции: БК-0010-01 (Вильнюс Бейсик 86), БК-0011М (Бейсик Экситон), БК+НГМД, БК-0010 (Фокал)</li>
<li>F12 - Предустановить режим цвета эмулятора</li>
<li>Alt + F10 - Монтировать SD-card мурмулятора, как USB-drive</li>
</ul>

Конфигурационный файл (BK\bk.conf):
<ul>
<li>mode: - значения от 0 до 5 - режимы страта:
<ul>
<li>0 - БК-0010 + КНГМД</li>
<li>1 - БК-0010 + Фокал</li>
<li>2 - БК-0010-01 + Бейсик 86</li>
<li>3 - БК-0011М + КНГМД</li>
<li>4 - БК-0011М + МСТД</li>
</ul>
</li>
<li>is_covox_on: - 0/1</li>
<li>is_AY_on: - 0/1</li>
<li>color_mode: - 0/1</li>
<li>snd_volume: - -16..5</li>
<li>graphics_pallette_idx: - 0..15</li>
</ul>
